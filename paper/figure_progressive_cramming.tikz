\begin{tikzpicture}[
    >=Stealth,
    node distance=0.8cm,
    emb/.style={draw, rounded corners, fill=blue!20, minimum width=1.2cm, minimum height=0.7cm, font=\footnotesize},
    llm/.style={draw, fill=gray!20, minimum width=1.5cm, minimum height=1cm, font=\footnotesize},
    token/.style={draw, fill=green!20, minimum width=0.6cm, minimum height=0.6cm, font=\scriptsize},
    check/.style={text=green!60!black, font=\bfseries},
    stage/.style={font=\small\bfseries, text=black!70},
    optim/.style={->, thick, blue!60, dashed},
    init/.style={->, thick, orange!70!black},
]

% === STAGE k ===
\node[stage] (stage1) {\makebox[1.5cm][r]{Step $k$}:};

\node[emb, right=0.5cm of stage1] (e1) {$\mathbf{e}^{(k)}$};
\node[llm, right=1cm of e1] (llm1) {LLM};
\node[token, right=1cm of llm1] (t1_1) {$t_1$};
\node[token, right=0.1cm of t1_1] (t1_2) {$t_2$};
\node[right=0.1cm of t1_2, font=\scriptsize] (dots1) {$\cdots$};
\node[token, right=0.1cm of dots1] (t1_k) {$t_k$};

% Arrows for stage k
\draw[->, thick] (e1) -- (llm1);
\draw[->, thick] (llm1) -- (t1_1);

% Checkmark
\node[check, right=0.3cm of t1_k] (check1) {\checkmark 100\%};

% Optimization loop for stage k - spans all tokens
\coordinate (loop1_right) at ($(t1_k.south) + (0, -0.5)$);
\coordinate (loop1_left) at ($(t1_1.south) + (0, -0.5)$);
\draw[optim] (t1_1.south) -- (loop1_left);
\draw[optim] (t1_2.south) -- ++(0, -0.5);
\draw[optim] (t1_k.south) -- (loop1_right);
\draw[optim] (loop1_right) -- (loop1_left) -| node[pos=0.05, below, font=\scriptsize, text=blue!60] {optimize} (e1.south);

% === STAGE k+1 ===
\node[stage, below=2cm of stage1] (stage2) {\makebox[1.5cm][r]{Step $k{+}1$}:};

\node[emb, right=0.5cm of stage2] (e2) {$\mathbf{e}^{(k+1)}$};
\node[llm, right=1cm of e2] (llm2) {LLM};
\node[token, right=1cm of llm2] (t2_1) {$t_1$};
\node[token, right=0.1cm of t2_1] (t2_2) {$t_2$};
\node[right=0.1cm of t2_2, font=\scriptsize] (dots2) {$\cdots$};
\node[token, right=0.1cm of dots2] (t2_k) {$t_k$};
\node[token, right=0.1cm of t2_k, fill=yellow!40] (t2_k1) {$t_{k+1}$};

% Arrows for stage k+1
\draw[->, thick] (e2) -- (llm2);
\draw[->, thick] (llm2) -- (t2_1);

% Checkmark
\node[check, right=0.3cm of t2_k1] (check2) {\checkmark 100\%};

% Optimization loop for stage k+1 - spans all tokens
\coordinate (loop2_right) at ($(t2_k1.south) + (0, -0.5)$);
\coordinate (loop2_left) at ($(t2_1.south) + (0, -0.5)$);
\draw[optim] (t2_1.south) -- (loop2_left);
\draw[optim] (t2_2.south) -- ++(0, -0.5);
\draw[optim] (t2_k.south) -- ++(0, -0.5);
\draw[optim] (t2_k1.south) -- (loop2_right);
\draw[optim] (loop2_right) -- (loop2_left) -| node[pos=0.05, below, font=\scriptsize, text=blue!60] {optimize} (e2.south);

% === INITIALIZATION ARROW ===
\draw[init] (e1.south west) -- (e2.north west)
    node[midway, left, font=\scriptsize, text=orange!70!black, align=center] {init from\\$\mathbf{e}^{(k)}$};

% === LABELS ===
\node[below=0.3cm of llm1, font=\tiny, text=gray] {(frozen)};
\node[below=0.3cm of llm2, font=\tiny, text=gray] {(frozen)};

\end{tikzpicture}